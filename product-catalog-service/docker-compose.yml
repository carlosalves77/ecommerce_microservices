services:
  postgres_product:
    image: postgres:16
    container_name: product-catalog-database
    environment:
      - POSTGRES_USER=${postgres_user}
      - POSTGRES_PASSWORD=${postgres_password}
      - POSTGRES_DB=${postgres_database}
    ports:
      - "5002:5432"
    networks:
      - internal
    volumes:
      - postgres_data:/var/lib/postgresql/data

  product-catalog-service:
    build:
      context: .
      target: runner
    image:  product-catalog-service:latest
    container_name:  product-catalog-service
    depends_on:
      - postgres_product
    env_file:
      - .env
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres_product:5432/${postgres_database}
      - SPRING_DATASOURCE_USERNAME=${spring_user}
      - SPRING_DATASOURCE_PASSWORD=${spring_password}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - SERVER_PORT=4000
      - SPRING_JPA_OPEN_IN_VIEW=false
      - SPRING_JPA_DATABASE_PLATFORM=org.hibernate.dialect.PostgreSQLDialect
      - KAFKA_BOOTSTRAP_SERVERS=kafka:19092

    ports:
      - "4000:4000"
    networks:
      - internal


  kafka:
    image: confluentinc/cp-kafka:latest
    container_name: kafka_container
    ports:
      - "9092:9092"
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - internal
    environment:

      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_NODE_ID=1
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093

      - KAFKA_CLUSTER_ID=4130088c-04e5-4f60-9c71-36021e32fd6d

      - KAFKA_LISTENERS=INTERNAL://:19092,CLIENT://:9092,CONTROLLER://:9093
      - KAFKA_ADVERTISED_LISTENERS=INTERNAL://kafka:19092,CLIENT://localhost:9092
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,INTERNAL:PLAINTEXT,CLIENT:PLAINTEXT
      - KAFKA_INTER_BROKER_LISTENER_NAME=INTERNAL

      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER

      # --- Configs KRaft (Nó Único) ---
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_AUTO_CREATE_TOPICS_ENABLE=true

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    ports:
      - "8090:8080"
    networks:
      - internal
    depends_on:
      - kafka
    environment:
      KAFKA_CLUSTERS_0_NAME: product-service-cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:19092
      KAFKA_CLUSTERS_0_ZOOKEEPER: ""

volumes:
  postgres_data:
  kafka_data:

networks:
  internal:
    external: true